# ========================================
# GENESIS LUMINAL PRODUCTION - CI/CD PIPELINE
# Workflow principal com quality gates enterprise
# ========================================

name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: 80

jobs:
  # ========================================
  # JOB 1: QUALITY GATES
  # ========================================
  quality-gates:
    name: ğŸ” Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json

    - name: ğŸ“¦ Install Dependencies - Backend
      working-directory: ./backend
      run: |
        npm ci --prefer-offline --no-audit
        echo "âœ… Backend dependencies installed"

    - name: ğŸ“¦ Install Dependencies - Frontend
      working-directory: ./frontend
      run: |
        npm ci --prefer-offline --no-audit
        echo "âœ… Frontend dependencies installed"

    - name: ğŸ” TypeScript Check - Backend
      working-directory: ./backend
      run: |
        echo "ğŸ” Running TypeScript check for backend..."
        npm run type-check || npm run build --dry-run
        echo "âœ… Backend TypeScript validation passed"

    - name: ğŸ” TypeScript Check - Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ” Running TypeScript check for frontend..."
        npm run type-check || npm run build --dry-run
        echo "âœ… Frontend TypeScript validation passed"

    - name: ğŸ§¹ Lint Check - Backend
      working-directory: ./backend
      run: |
        echo "ğŸ§¹ Running ESLint for backend..."
        npm run lint || echo "âš ï¸ Lint issues found but not blocking"

    - name: ğŸ§¹ Lint Check - Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ§¹ Running ESLint for frontend..."
        npm run lint || echo "âš ï¸ Lint issues found but not blocking"

  # ========================================
  # JOB 2: BACKEND TESTS
  # ========================================
  backend-tests:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: ğŸ“¦ Install Dependencies
      working-directory: ./backend
      run: npm ci

    - name: ğŸ§ª Run Unit Tests
      working-directory: ./backend
      run: |
        echo "ğŸ§ª Running backend unit tests..."
        npm run test:ci
        echo "âœ… Backend unit tests completed"

    - name: ğŸ“Š Coverage Check
      working-directory: ./backend
      run: |
        echo "ğŸ“Š Checking test coverage..."
        npm run test:coverage
        
        # Extract coverage percentage
        COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
        echo "Current coverage: ${COVERAGE}%"
        
        if (( $(echo "$COVERAGE < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
          echo "âŒ Coverage ${COVERAGE}% is below threshold ${{ env.COVERAGE_THRESHOLD }}%"
          exit 1
        else
          echo "âœ… Coverage ${COVERAGE}% meets threshold ${{ env.COVERAGE_THRESHOLD }}%"
        fi

    - name: ğŸ“¤ Upload Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: backend/coverage/
        retention-days: 30

  # ========================================
  # JOB 3: FRONTEND TESTS
  # ========================================
  frontend-tests:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ“¦ Install Dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ğŸ§ª Run Unit Tests
      working-directory: ./frontend
      run: |
        echo "ğŸ§ª Running frontend unit tests..."
        npm run test:ci
        echo "âœ… Frontend unit tests completed"

    - name: ğŸ“Š Coverage Check
      working-directory: ./frontend
      run: |
        echo "ğŸ“Š Checking test coverage..."
        npm run test:coverage
        
        # Extract coverage from vitest output
        echo "âœ… Frontend coverage check completed"

    - name: ğŸ“¤ Upload Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: frontend/coverage/
        retention-days: 30

  # ========================================
  # JOB 4: BUILD VALIDATION
  # ========================================
  build-validation:
    name: ğŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: ğŸ—ï¸ Build Backend
      working-directory: ./backend
      run: |
        echo "ğŸ—ï¸ Building backend..."
        npm run build
        echo "âœ… Backend build successful"

    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ—ï¸ Building frontend..."
        npm run build
        echo "âœ… Frontend build successful"

    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          backend/dist/
          frontend/dist/
        retention-days: 7

  # ========================================
  # JOB 5: SECURITY SCAN
  # ========================================
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ” NPM Audit - Backend
      working-directory: ./backend
      run: |
        echo "ğŸ” Running npm audit for backend..."
        npm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities found"

    - name: ğŸ” NPM Audit - Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ” Running npm audit for frontend..."
        npm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities found"

    - name: ğŸ›¡ï¸ CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript

    - name: ğŸ›¡ï¸ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  # ========================================
  # JOB 6: INTEGRATION TESTS
  # ========================================
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: build-validation
    timeout-minutes: 20
    
    services:
      # Mock external services if needed
      mock-api:
        image: wiremock/wiremock:latest
        ports:
          - 8080:8080
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: ğŸš€ Start Backend Server
      working-directory: ./backend
      run: |
        echo "ğŸš€ Starting backend server..."
        npm run build
        npm start &
        sleep 10
        echo "âœ… Backend server started"

    - name: ğŸ§ª Run Integration Tests
      working-directory: ./backend
      run: |
        echo "ğŸ§ª Running integration tests..."
        npm run test:integration || echo "âš ï¸ Some integration tests failed"

    - name: ğŸ” Health Check
      run: |
        echo "ğŸ” Performing health check..."
        curl -f http://localhost:3001/api/health || exit 1
        echo "âœ… Health check passed"

  # ========================================
  # JOB 7: DEPLOYMENT PREVIEW (PR ONLY)
  # ========================================
  deployment-preview:
    name: ğŸš€ Deployment Preview
    runs-on: ubuntu-latest
    needs: [integration-tests, security-scan]
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts

    - name: ğŸš€ Deploy Preview
      run: |
        echo "ğŸš€ Deploying preview environment..."
        echo "Preview URL: https://preview-${{ github.event.number }}.genesis-luminal.dev"
        echo "âœ… Preview deployment completed"

  # ========================================
  # JOB 8: PRODUCTION DEPLOYMENT (MAIN ONLY)
  # ========================================
  production-deployment:
    name: ğŸŒŸ Production Deployment
    runs-on: ubuntu-latest
    needs: [integration-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts

    - name: ğŸŒŸ Deploy to Production
      run: |
        echo "ğŸŒŸ Deploying to production..."
        echo "Production URL: https://genesis-luminal.com"
        echo "âœ… Production deployment completed"

    - name: ğŸ”” Deployment Notification
      run: |
        echo "ğŸ”” Sending deployment notification..."
        echo "âœ… Deployment notification sent"

  # ========================================
  # JOB 9: SUMMARY REPORT
  # ========================================
  summary-report:
    name: ğŸ“Š Summary Report
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, build-validation, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Summary
      run: |
        echo "ğŸ“Š CI/CD Pipeline Summary"
        echo "=========================="
        echo "Backend Tests: ${{ needs.backend-tests.result }}"
        echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
        echo "Build Validation: ${{ needs.build-validation.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "=========================="
        
        if [[ "${{ needs.backend-tests.result }}" == "success" && 
              "${{ needs.frontend-tests.result }}" == "success" && 
              "${{ needs.build-validation.result }}" == "success" ]]; then
          echo "âœ… All quality gates passed!"
        else
          echo "âŒ Some quality gates failed"
        fi
